<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BudgetFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #f8fafc;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">

    <!-- Navigation -->
    <nav class="glass sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="dashboard.html"
                        class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-teal-400 to-blue-500">BudgetFlow</a>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="dashboard.html"
                            class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition hover:bg-white/10">Dashboard</a>
                        <a href="view_all.html"
                            class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition hover:bg-white/10">Transactions</a>
                        <a href="create.html"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-medium transition shadow-lg shadow-blue-500/30">Add
                            Expense</a>
                        <a href="search.html"
                            class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition hover:bg-white/10">Search</a>
                        <a href="report.html"
                            class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition hover:bg-white/10">Reports</a>
                    </div>
                </div>
                <div>
                    <a href="#" id="logout-btn"
                        class="text-red-400 hover:text-red-300 text-sm font-medium transition">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Financial Overview -->
            <div class="lg:col-span-2 space-y-8">

                <!-- Primary Card: Remaining Income -->
                <div class="relative overflow-hidden rounded-2xl glass p-8">
                    <div class="relative z-10">
                        <h2 class="text-gray-400 text-sm font-semibold uppercase tracking-wider">Remaining Unallocated
                            Income</h2>
                        <div class="mt-2 flex items-baseline">
                            <span class="text-4xl font-bold text-white" id="remaining-income">$0.00</span>
                            <span class="ml-2 text-sm text-gray-400">available</span>
                        </div>
                        <div class="mt-4">
                            <span class="text-sm text-gray-400">
                                Total Income: <span class="text-white" id="total-income">$0.00</span> -
                                <span class="text-red-400" id="total-allocation">$0.00</span> (Allocated & Removed)
                            </span>
                        </div>
                    </div>
                    <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-emerald-500/20 blur-3xl">
                    </div>
                </div>

                <!-- Allocation Tasks -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-white">Income Deconstruction</h2>
                        <span class="text-xs text-gray-500 bg-slate-800 px-2 py-1 rounded">Active Tasks</span>
                    </div>
                    <div class="grid gap-4" id="allocations-container">
                        <!-- Allocations will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Add New Task -->
            <div class="space-y-8">
                <div class="rounded-2xl glass p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Add Allocation</h3>
                    <form id="add-allocation-form" class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">Task Name</label>
                            <input type="text" name="allocation_name" id="allocation_name" placeholder="e.g. Rent"
                                required
                                class="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">Amount</label>
                            <input type="number" step="0.01" name="allocation_amount" id="allocation_amount"
                                placeholder="0.00" required
                                class="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">Category (Optional)</label>
                            <select name="category_id" id="category_id"
                                class="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition">
                                <option value="">No Category</option>
                            </select>
                        </div>
                        <button type="submit"
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-semibold py-3 rounded-lg shadow-lg shadow-indigo-500/20 transition transform hover:scale-[1.02]">
                            Split Income
                        </button>
                    </form>
                </div>

                <div
                    class="rounded-2xl bg-gradient-to-br from-purple-900/40 to-slate-900/40 border border-purple-500/20 p-6">
                    <h4 class="text-purple-300 font-semibold mb-2">Note</h4>
                    <p class="text-sm text-gray-400">
                        Removing a task hides it from the list but keeps the amount deducted from your income plan.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <footer class="glass mt-auto py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
            &copy; 2026 BudgetFlow. Designed for Students.
        </div>
    </footer>

    <script>
        // Check auth on page load
        async function checkAuth() {
            const response = await fetch('../api/auth_check.php');
            const data = await response.json();
            if (!data.authenticated) {
                window.location.href = 'login.html';
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            const response = await fetch('../api/dashboard.php?action=get');
            const data = await response.json();

            if (data.success) {
                const { categories, allocations, total_allocation, total_income } = data.data;

                // Update totals
                document.getElementById('remaining-income').textContent = '$' + (total_income - total_allocation).toFixed(2);
                document.getElementById('total-income').textContent = '$' + parseFloat(total_income).toFixed(2);
                document.getElementById('total-allocation').textContent = '$' + parseFloat(total_allocation).toFixed(2);

                // Populate categories dropdown
                const categorySelect = document.getElementById('category_id');
                categorySelect.innerHTML = '<option value="">No Category</option>';
                categories.forEach(cat => {
                    categorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });

                // Render allocations
                const container = document.getElementById('allocations-container');
                if (allocations.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">No active tasks. Add one to split your income!</div>';
                } else {
                    container.innerHTML = allocations.map(item => `
                        <div class="group relative rounded-xl glass p-4 transition hover:bg-white/5 flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <a href="#" onclick="toggleAllocation(${item.id}); return false;" class="flex-shrink-0 cursor-pointer">
                                    ${item.is_paid ?
                            '<div class="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-white shadow-[0_0_10px_rgba(16,185,129,0.5)]"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>' :
                            '<div class="w-6 h-6 rounded-full border-2 border-gray-500 group-hover:border-emerald-400 transition"></div>'
                        }
                                </a>
                                <div>
                                    <p class="text-lg font-medium ${item.is_paid ? 'text-gray-500 line-through decoration-emerald-500/50' : 'text-white'}">${item.name}</p>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm font-mono text-gray-400">$${parseFloat(item.amount).toFixed(2)}</span>
                                        ${item.category_name ? `<span class="text-xs text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded">${item.category_name}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <a href="#" onclick="deleteAllocation(${item.id}); return false;" class="text-gray-600 hover:text-red-400 transition p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </a>
                        </div>
                    `).join('');
                }
            }
        }

        // Add allocation
        document.getElementById('add-allocation-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const name = document.getElementById('allocation_name').value;
            const amount = document.getElementById('allocation_amount').value;
            const category_id = document.getElementById('category_id').value;

            await fetch('../api/dashboard.php?action=add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, amount, category_id })
            });

            this.reset();
            loadDashboard();
        });

        // Toggle allocation
        async function toggleAllocation(id) {
            await fetch(`../api/dashboard.php?action=toggle&id=${id}`);
            loadDashboard();
        }

        // Delete allocation
        async function deleteAllocation(id) {
            if (confirm('Remove task? (Amount will still be deducted from total)')) {
                await fetch(`../api/dashboard.php?action=delete&id=${id}`);
                loadDashboard();
            }
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async function (e) {
            e.preventDefault();
            await fetch('../api/logout.php');
            window.location.href = 'login.html';
        });

        // Initialize
        checkAuth();
        loadDashboard();
    </script>

</body>

</html>